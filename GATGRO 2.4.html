<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Fiscalização de Trânsito Agropecuário</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        h1, h2 { text-align: center; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 5px; margin-top: 5px; }
        button { display: inline-block; padding: 5px 10px; margin: 5px; background-color: #4CAF50; color: white; border: none; cursor: pointer; }
        button:hover { background-color: #45a049; }
        #dadosSalvos { margin-top: 20px; padding: 10px; background-color: #f0f0f0; white-space: pre-wrap; }
        .registro { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
        #planilhaResumo { margin-top: 20px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid black; padding: 4px; text-align: left; font-size: 10px; word-wrap: break-word; white-space: normal; }
        /* Removed display: none; for initial forms, controlled by JS now */
        .outros-campo { display: none; }
        
        /* Adicionado para esconder os botões de incremento/decremento do input number */
        input[type=number]::-webkit-outer-spin-button,
        input[type=number]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Estilos para a funcionalidade de câmera */
        #camera-container {
            margin-top: 20px;
            text-align: center;
        }
        #video-stream {
            display: none;
            width: 100%;
            max-width: 400px;
            border: 1px solid #ccc;
        }
        #photo-canvas, #captured-image {
            display: none;
            width: 100%;
            max-width: 400px;
            margin-top: 10px;
        }

        #lista_servidores ul { list-style: none; padding: 0; }
        #lista_servidores li { background-color: #e9e9e9; margin-bottom: 5px; padding: 5px; display: flex; justify-content: space-between; align-items: center; }
        #lista_servidores li button { background-color: #f44336; padding: 3px 6px; font-size: 0.8em; }

        @media print {
            body * { visibility: hidden; }
            #planilhaResumo, #planilhaResumo * { visibility: visible; }
            #planilhaResumo { position: absolute; left: 0; top: 0; }
            @page {
                size: A4 landscape;
                margin: 1.5cm;
            }
            table { page-break-inside: avoid; table-layout: fixed; width: 100%; }
            th, td { font-size: 7px; padding: 1px; word-wrap: break-word; overflow: hidden; text-overflow: ellipsis; }
        }
    </style>
</head>
<body>
    <h1>Planilha de Controle de Fiscalização de Trânsito Agropecuário</h1>
    <form id="fiscalizacaoForm">
        <h2>Informações Iniciais da Fiscalização</h2>

        <label for="atividade_realizada">A atividade já foi realizada?</label>
        <select id="atividade_realizada" name="atividade_realizada" onchange="handleActivityChange()">
            <option value="Sim">Sim</option>
            <option value="Nao">realizando a atividade</option>
        </select>

        <label for="data">Data da Fiscalização:</label>
        <input type="date" id="data" name="data" required>

        <label for="tipo_local">Tipo de Local de Fiscalização:</label>
        <select id="tipo_local" name="tipo_local" required>
            <option value="">Selecione...</option>
            <option value="Posto Fiscal">Posto Fiscal</option>
            <option value="Fiscalizacao Movel">Fiscalização Móvel</option>
        </select>

        <label for="municipio_fiscalizacao_pa">Município da Fiscalização (Pará):</label>
        <select id="municipio_fiscalizacao_pa" name="municipio_fiscalizacao_pa" required>
            <option value="">Selecione um Município</option>
        </select>

        <label>Servidor(es) Responsável(is):</label>
        <input type="text" id="nome_servidor" placeholder="Nome do servidor">
        <button type="button" onclick="addServidor()">Adicionar Servidor</button>
        <div id="lista_servidores"></div>
        <p id="servidores_obrigatorio_msg" style="color: red; display: none;">Adicione pelo menos um servidor.</p>

        <button type="button" onclick="submitInitialForm()">Confirmar Dados Iniciais</button>
    </form>

    <form id="novoRegistroForm" style="display: none;">
        <h2>Novo Registro</h2>

        <div id="camera-container">
            <button type="button" id="toggle-camera-btn" onclick="toggleCamera()">Abrir Câmera</button>
            <video id="video-stream" autoplay></video>
            <canvas id="photo-canvas" style="display: none;"></canvas>
            <img id="captured-image" alt="Imagem Capturada">
        </div>

        <label for="placa">Placa ou nome da embarcação:</label>
        <input type="text" id="placa" name="placa" required>

        <label for="tipo_documento">Tipo de documento:</label>
        <select id="tipo_documento" name="tipo_documento" onchange="toggleOutrosCampo('tipo_documento_outros')" required>
            <option value="">Selecione...</option>
            <option value="GTA">GTA</option>
            <option value="GTV">GTV</option>
            <option value="GTS">GTS</option>
            <option value="CIS-E">CIS-E</option>
            <option value="NOTA FISCAL">NOTA FISCAL</option>
            <option value="OUTROS">OUTROS</option>
        </select>
        <input type="text" id="tipo_documento_outros" name="tipo_documento_outros" placeholder="Especifique o tipo de documento" class="outros-campo">

        <label for="numero_documento">Número do documento:</label>
        <input type="number" id="numero_documento" name="numero_documento" min="0" required>

        <label for="serie_documento">Série do documento:</label>
        <input type="text" id="serie_documento" name="serie_documento" oninput="this.value = this.value.replace(/[^A-Za-z0-9]/g, '');" required>

        <label for="finalidade">Finalidade do trânsito:</label>
        <select id="finalidade" name="finalidade" onchange="toggleOutrosCampo('finalidade_outros')" required>
            <option value="">Selecione...</option>
            <option value="Abate">Abate</option>
            <option value="Engorda">Engorda</option>
            <option value="Comércio">Comércio</option>
            <option value="Indústria">Indústria</option>
            <option value="OUTROS">OUTROS</option>
        </select>
        <input type="text" id="finalidade_outros" name="finalidade_outros" placeholder="Especifique a finalidade" class="outros-campo">

        <label for="especie">Espécie, cultura, produto ou subproduto:</label>
        <select id="especie" name="especie" onchange="toggleOutrosCampo('especie_outros')" required>
            <option value="">Selecione...</option>
            <optgroup label="Animais">
                <option value="Bovino">Bovino</option>
                <option value="Suíno">Suíno</option>
                <option value="Aves">Aves</option>
            </optgroup>
            <optgroup label="Produtos Vegetais">
                <option value="Açaí">Açaí</option>
                <option value="Cacau">Cacau</option>
                <option value="Cana de açúcar">Cana de açúcar</option>
                <option value="Farinha de Mandioca">Farinha de Mandioca</option>
                <option value="Milho">Milho</option>
                <option value="Tucupi">Tucupi</option>
            </optgroup>
            <option value="OUTROS">OUTROS</option>
        </select>
        <input type="text" id="especie_outros" name="especie_outros" placeholder="Especifique a espécie" class="outros-campo" oninput="this.value = this.value.replace(/[^A-Za-z\s]/g, '')">

        <label for="quantidade">Quantidade:</label>
        <input type="number" id="quantidade" name="quantidade" min="0" required>

        <label for="unidade_medida">Unidade de medida:</label>
        <select id="unidade_medida" name="unidade_medida" onchange="toggleOutrosCampo('unidade_medida_outros')" required>
            <option value="">Selecione...</option>
            <option value="KG">KG</option>
            <option value="TONELADA">TONELADA</option>
            <option value="UNIDADE">UNIDADE</option>
            <option value="LITROS">LITROS</option>
            <option value="LATAS">LATAS</option>
            <option value="OUTROS">OUTROS</option>
        </select>
        <input type="text" id="unidade_medida_outros" name="unidade_medida_outros" placeholder="Especifique a unidade de medida" class="outros-campo">

        <label for="estado_origem">Estado de origem:</label>
        <select id="estado_origem" name="estado_origem" onchange="updateMunicipios('origem')" required></select>

        <label for="municipio_origem">Município de origem:</label>
        <div id="municipio_origem_container">
            <input type="text" id="municipio_origem" name="municipio_origem" required>
        </div>

        <label for="estado_destino">Estado de destino:</label>
        <select id="estado_destino" name="estado_destino" onchange="updateMunicipios('destino')" required></select>

        <label for="municipio_destino">Município de destino:</label>
        <div id="municipio_destino_container">
            <input type="text" id="municipio_destino" name="municipio_destino" required>
        </div>

        <button type="button" onclick="adicionarRegistro()">Salvar Registro</button>
        <button type="button" onclick="cancelarNovoRegistro()">Cancelar</button>
    </form>

    <div id="novosRegistros" style="display: none;">
        <h2>Registros Adicionados:</h2>
        <div id="registrosPreview"></div> <button type="button" onclick="mostrarFormularioNovoRegistro()">Adicionar Novo Registro</button>
        <button type="button" onclick="revisarDados()">Revisar Dados Inseridos</button>
        <button type="button" onclick="mostrarFormularioInfracao()">Adicionar Auto de Infração</button> <button type="button" onclick="finalizarExpediente()">Finalizar Expediente</button>
    </div>
    
    <div id="revisaoRegistros" style="display: none;"></div>
    
    <form id="autoInfracaoForm" style="display: none;">
        <h2>Registro de Auto de Infração</h2>

        <div id="camera-container-infracao">
            <button type="button" onclick="toggleCameraInfracao()">Tirar Foto do Auto</button>
            <video id="video-stream-infracao" autoplay></video>
            <canvas id="photo-canvas-infracao" style="display: none;"></canvas>
            <img id="captured-image-infracao" alt="Foto do Auto de Infração" style="display: none;">
        </div>

        <label for="numero_auto">Número do Auto de Infração:</label>
        <input type="text" id="numero_auto" name="numero_auto" oninput="this.value = this.value.replace(/[^0-9\/-]/g, '');" required>
        
        <label for="serie_auto">Série do Auto de Infração:</label>
        <input type="text" id="serie_auto" name="serie_auto" oninput="this.value = this.value.replace(/[^A-Za-z]/g, '').slice(0, 1);" maxlength="1" required>
        
        <label for="defesa_sanitaria">Tipo de Defesa Sanitária:</label>
        <select id="defesa_sanitaria" name="defesa_sanitaria" required>
            <option value="Animal">Animal</option>
            <option value="Vegetal">Vegetal</option>
        </select>
        
        <label for="observacao_auto">Observação:</label>
        <textarea id="observacao_auto" name="observacao_auto" rows="4"></textarea>

        <button type="button" onclick="salvarAutoInfracao()">Salvar Auto de Infração</button>
        <button type="button" onclick="cancelarAutoInfracao()">Cancelar</button>
    </form>
    
    <div id="infracoesSalvas" style="display: none;">
        <h2>Autos de Infração Registrados:</h2>
        <button type="button" onclick="mostrarFormularioInfracao()">Adicionar Outro Auto de Infração</button>
        <button type="button" onclick="exibirResumoFinal()">Finalizar Expediente</button>
    </div>

    <div id="planilhaResumo" style="display: none;"></div>
    <p>Os dados devem ser transmitidos através do link: <a href="#" target="_blank">Formulário de Transmissão</a>.</p>

    <script>
        let registros = [];
        let infracaoRegistros = [];
        let servidoresResponsavel = []; // New array to store multiple servers
        let videoStream = null;
        let videoStreamInfracao = null;

        const brazilianStates = [
            'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
        ];

        const paraMunicipios = [
            'Abaetetuba', 'Abel Figueiredo', 'Acará', 'Afuá', 'Água Azul do Norte', 'Alenquer', 'Almeirim', 'Altamira', 'Anajás', 'Ananindeua', 'Anapu', 'Augusto Corrêa', 'Aurora do Pará', 'Aveiro', 'Bagre', 'Baião', 'Bannach', 'Barcarena', 'Belém', 'Belterra', 'Benevides', 'Bom Jesus do Tocantins', 'Bonito', 'Bragança', 'Brasil Novo', 'Brejo Grande do Araguaia', 'Breu Branco', 'Breves', 'Bujaru', 'Cachoeira do Arari', 'Cachoeira do Piriá', 'Cametá', 'Canaã dos Carajás', 'Capanema', 'Capitão Poço', 'Castanhal', 'Chaves', 'Colares', 'Conceição do Araguaia', 'Cumaru do Norte', 'Curionópolis', 'Curralinho', 'Curuá', 'Curuçá', 'Dom Eliseu', 'Eldorado do Carajás', 'Faro', 'Floresta do Araguaia', 'Garrafão do Norte', 'Goianésia do Pará', 'Gurupá', 'Igarapé-Açu', 'Igarapé-Miri', 'Inhangapi', 'Ipixuna do Pará', 'Irituia', 'Itupiranga', 'Jacareacanga', 'Jacundá', 'Juruti', 'Limoeiro do Ajuru', 'Magalhães Barata', 'Marabá', 'Maracanã', 'Marapanim', 'Marituba', 'Medicilândia', 'Melgaço', 'Moju', 'Mojuí dos Campos', 'Monte Alegre', 'Muaná', 'Nova Esperança do Piriá', 'Nova Ipixuna', 'Nova Timboteua', 'Novo Progresso', 'Novo Repartimento', 'Óbidos', 'Oeiras do Pará', 'Oriximiná', 'Ourém', 'Ourilândia do Norte', 'Pacajá', 'Palestina do Pará', 'Paragominas', 'Parauapebas', 'Pau d\'Arco', 'Peixe-Boi', 'Piçarra', 'Placas', 'Ponta de Pedras', 'Portel', 'Porto de Moz', 'Prainha', 'Quatipuru', 'Redenção', 'Rio Maria', 'Rondon do Pará', 'Rurópolis', 'Salinópolis', 'Santa Bárbara do Pará', 'Santa Cruz do Arari', 'Santa Isabel do Pará', 'Santa Luzia do Pará', 'Santa Maria das Barreiras', 'Santa Maria do Pará', 'Santana do Araguaia', 'Santarém', 'Santarém Novo', 'Santo Antônio do Tauá', 'São Caetano de Odivelas', 'São Domingos do Araguaia', 'São Domingos do Capim', 'São Félix do Xingu', 'São Francisco do Pará', 'São Geraldo do Araguaia', 'São João da Ponta', 'São João de Pirabas', 'São João do Araguaia', 'São Miguel do Guamá', 'São Sebastião da Boa Vista', 'Sapucaia', 'Senador José Porfírio', 'Soure', 'Tailândia', 'Terra Alta', 'Terra Santa', 'Tomé-Açu', 'Tracuateua', 'Trairão', 'Tucumã', 'Tucuruí', 'Ulianópolis', 'Uruará', 'Vigia', 'Viseu', 'Vitória do Xingu', 'Xinguara'
        ].sort();

        function populateStates() {
            const origemSelect = document.getElementById('estado_origem');
            const destinoSelect = document.getElementById('estado_destino');
            
            brazilianStates.forEach(state => {
                const optionOrigem = document.createElement('option');
                optionOrigem.value = state;
                optionOrigem.textContent = state;
                origemSelect.appendChild(optionOrigem);

                const optionDestino = document.createElement('option');
                optionDestino.value = state;
                optionDestino.textContent = state;
                destinoSelect.appendChild(optionDestino);
            });
        }

        function populateParaMunicipios(selectId) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = '<option value="">Selecione um Município</option>'; // Reset options
            paraMunicipios.forEach(municipio => {
                const option = document.createElement('option');
                option.value = municipio;
                option.textContent = municipio;
                selectElement.appendChild(option);
            });
        }

        function updateMunicipios(type) {
            const estadoSelect = document.getElementById(`estado_${type}`);
            const municipioContainer = document.getElementById(`municipio_${type}_container`);
            const selectedState = estadoSelect.value;
            
            municipioContainer.innerHTML = '';
            
            if (selectedState === 'PA') {
                const municipioSelect = document.createElement('select');
                municipioSelect.id = `municipio_${type}`;
                municipioSelect.name = `municipio_${type}`;
                municipioSelect.required = true;

                paraMunicipios.forEach(municipio => {
                    const option = document.createElement('option');
                    option.value = municipio;
                    option.textContent = municipio;
                    municipioSelect.appendChild(option);
                });
                
                municipioContainer.appendChild(municipioSelect);
            } else {
                const municipioInput = document.createElement('input');
                municipioInput.type = 'text';
                municipioInput.id = `municipio_${type}`;
                municipioInput.name = `municipio_${type}`;
                municipioInput.required = true;
                municipioContainer.appendChild(municipioInput);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            populateStates();
            populateParaMunicipios('municipio_fiscalizacao_pa'); // Populate the new municipality select
            handleActivityChange();
            
            // Initial form visibility
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('autoInfracaoForm').style.display = 'none';
            document.getElementById('infracoesSalvas').style.display = 'none';
            document.getElementById('planilhaResumo').style.display = 'none';
        });


        function getLocalDateString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function handleActivityChange() {
            const activitySelect = document.getElementById('atividade_realizada');
            const dateInput = document.getElementById('data');
            const today = new Date();
            const todayString = getLocalDateString(today);
            const yesterday = new Date(today);
            yesterday.setDate(today.getDate() - 1);
            const yesterdayString = getLocalDateString(yesterday);

            if (activitySelect.value === 'Sim') {
                dateInput.value = '';
                dateInput.min = '';
                dateInput.max = yesterdayString;
            } else { // Caso 'Nao', agora com o texto 'realizando a atividade'
                dateInput.value = todayString;
                dateInput.max = todayString;
                dateInput.min = todayString;
            }
        }
        
        function toggleOutrosCampo(campoId) {
            const selectElement = document.getElementById(campoId.replace('_outros', ''));
            const outrosInput = document.getElementById(campoId);
            if (selectElement.value === 'OUTROS') {
                outrosInput.style.display = 'block';
                outrosInput.required = true;
            } else {
                outrosInput.style.display = 'none';
                outrosInput.required = false;
                outrosInput.value = '';
            }
        }

        function submitInitialForm() {
            const form = document.getElementById('fiscalizacaoForm');
            const dataFiscalizacao = document.getElementById('data').value;
            const tipoLocal = document.getElementById('tipo_local').value;
            const municipioFiscalizacaoPA = document.getElementById('municipio_fiscalizacao_pa').value;

            // Basic validation
            if (!dataFiscalizacao || !tipoLocal || !municipioFiscalizacaoPA || servidoresResponsavel.length === 0) {
                alert('Por favor, preencha todos os campos obrigatórios e adicione pelo menos um servidor.');
                if (servidoresResponsavel.length === 0) {
                     document.getElementById('servidores_obrigatorio_msg').style.display = 'block';
                }
                return;
            }

            // Hide initial form and show registration form
            form.style.display = 'none';
            document.getElementById('novoRegistroForm').style.display = 'block';
            document.getElementById('novosRegistros').style.display = 'block'; // Show added records section
            updateRecordsPreview(); // Initial update for preview
        }

        function mostrarFormularioNovoRegistro() {
            document.getElementById('novoRegistroForm').style.display = 'block';
            document.getElementById('novoRegistroForm').reset();
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('planilhaResumo').style.display = 'none';
            document.getElementById('autoInfracaoForm').style.display = 'none'; // Ensure auto infracao form is hidden
            document.getElementById('infracoesSalvas').style.display = 'none'; // Ensure saved infractions are hidden
            document.querySelectorAll('.outros-campo').forEach(campo => {
                campo.style.display = 'none';
                campo.required = false;
            });
            // Reset camera for new record
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            document.getElementById('video-stream').style.display = 'none';
            document.getElementById('captured-image').style.display = 'none';
            document.getElementById('toggle-camera-btn').textContent = 'Abrir Câmera';
        }

        function cancelarNovoRegistro() {
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('novoRegistroForm').reset();
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'block';
            document.getElementById('planilhaResumo').style.display = 'none';
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                document.getElementById('video-stream').style.display = 'none';
                document.getElementById('toggle-camera-btn').textContent = 'Abrir Câmera';
            }
        }

        function adicionarRegistro() {
            // Validação do campo 'Série do documento'
            const serieValue = document.getElementById('serie_documento').value;
            const isLettersOnly = /^[A-Za-z]+$/.test(serieValue);
            const isNumbersOnly = /^[0-9]+$/.test(serieValue);
            
            if (serieValue && !isLettersOnly && !isNumbersOnly) {
                alert('A Série do documento deve conter apenas letras ou apenas números, sem mistura.');
                return;
            }

            const form = document.getElementById('novoRegistroForm');
            const novoRegistro = {};
            for (let i = 0; i < form.elements.length; i++) {
                if (form.elements[i].name && form.elements[i].value) {
                    let value = form.elements[i].value;
                    // Handle "OUTROS" fields to store the actual specified value
                    if (form.elements[i].name.endsWith('_outros')) {
                        const originalSelectName = form.elements[i].name.replace('_outros', '');
                        if (document.getElementById(originalSelectName) && document.getElementById(originalSelectName).value === 'OUTROS') {
                            novoRegistro[originalSelectName] = value; // Replace "OUTROS" with the specified text
                        } else {
                            novoRegistro[form.elements[i].name] = value;
                        }
                    } else {
                        novoRegistro[form.elements[i].name] = value;
                    }
                }
            }
            
            // Explicitly handle "OUTROS" fields if they were filled
            ['tipo_documento', 'finalidade', 'especie', 'unidade_medida'].forEach(field => {
                const selectElement = document.getElementById(field);
                const outrosInputElement = document.getElementById(`${field}_outros`);
                if (selectElement && outrosInputElement && selectElement.value === 'OUTROS') {
                    novoRegistro[field] = outrosInputElement.value;
                }
            });


            // Adicionar a data e hora do lançamento
            const dataLancamento = new Date();
            novoRegistro.dataHoraLancamento = dataLancamento.toLocaleString();
            
            // Adicionar a data da fiscalização do form principal no formato DD/MM/AAAA
            const dataPrincipal = document.getElementById('data').value;
            if (dataPrincipal) {
                const [ano, mes, dia] = dataPrincipal.split('-');
                novoRegistro.data = `${dia}/${mes}/${ano}`;
            }
            
            // Adicionar a imagem capturada se existir
            const capturedImage = document.getElementById('captured-image').src;
            if (capturedImage && capturedImage !== '') {
                novoRegistro.imagemPlaca = capturedImage;
            }

            registros.push(novoRegistro);
            // After adding, return to 'novosRegistros' section and update preview
            cancelarNovoRegistro(); // This will show 'novosRegistros'
            updateRecordsPreview(); // Update the preview
        }

        function updateRecordsPreview() {
            const previewDiv = document.getElementById('registrosPreview');
            previewDiv.innerHTML = ''; // Clear existing preview

            if (registros.length === 0) {
                previewDiv.innerHTML = '<p>Nenhum registro adicionado ainda.</p>';
            } else {
                let html = '<ul>';
                registros.slice(-5).forEach((registro, index) => { // Show last 5 records
                    const originalIndex = registros.length - 5 + index; // Get true index for editing
                    html += `<li>Registro ${originalIndex + 1}: Placa: ${registro.placa || 'N/A'}, Documento: ${registro.numero_documento || 'N/A'} <button onclick="editarRegistro(${originalIndex})">Editar</button> <button onclick="excluirRegistro(${originalIndex})">Excluir</button></li>`;
                });
                html += '</ul>';
                if (registros.length > 5) {
                    html += `<p>... e mais ${registros.length - 5} registro(s).</p>`;
                }
                previewDiv.innerHTML = html;
            }
        }

        function editarRegistro(index) {
            const registro = registros[index];
            const form = document.getElementById('novoRegistroForm');
            
            // Clear all fields first to avoid old data lingering
            form.reset();
            document.querySelectorAll('.outros-campo').forEach(campo => {
                campo.style.display = 'none';
                campo.required = false;
            });

            for (let key in registro) {
                const element = form.elements[key];
                if (element) {
                    // Check if the original key was an "OUTROS" type but now has a direct value
                    const selectElement = document.getElementById(key);
                    const outrosInput = document.getElementById(`${key}_outros`);

                    if (selectElement && outrosInput) { // It's a select field that might have an "OUTROS" option
                         // Check if the value is one of the standard options for this select
                        const isStandardOption = Array.from(selectElement.options).some(option => option.value === registro[key] && option.value !== 'OUTROS');
                        
                        if (isStandardOption) {
                            selectElement.value = registro[key];
                            outrosInput.style.display = 'none';
                            outrosInput.required = false;
                            outrosInput.value = '';
                        } else { // It's a custom "OUTROS" value
                            selectElement.value = 'OUTROS';
                            outrosInput.value = registro[key];
                            outrosInput.style.display = 'block';
                            outrosInput.required = true;
                        }
                    } else { // Not a select/outros pair, just a regular input
                        element.value = registro[key];
                    }
                }
            }

            // Handle image display if editing
            const capturedImage = document.getElementById('captured-image');
            if (registro.imagemPlaca) {
                capturedImage.src = registro.imagemPlaca;
                capturedImage.style.display = 'block';
                document.getElementById('toggle-camera-btn').textContent = 'Tirar Outra Foto';
            } else {
                capturedImage.style.display = 'none';
                capturedImage.src = '';
                document.getElementById('toggle-camera-btn').textContent = 'Abrir Câmera';
            }

            form.style.display = 'block';
            registros.splice(index, 1); // Remove the old record, it will be re-added on save
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('planilhaResumo').style.display = 'none';
        }

        function excluirRegistro(index) {
            if (confirm("Tem certeza que deseja excluir este registro?")) {
                registros.splice(index, 1);
                revisarDados(); // Refresh the review list
                updateRecordsPreview(); // Also update the preview
            }
        }

        function revisarDados() {
            const revisaoDiv = document.getElementById('revisaoRegistros');
            revisaoDiv.innerHTML = '<h2>Revisão de Dados Inseridos:</h2>';
            if (registros.length === 0) {
                revisaoDiv.innerHTML += '<p>Nenhum registro adicionado para revisão.</p>';
            } else {
                registros.forEach((registro, index) => {
                    revisaoDiv.innerHTML += `
                        <div class='registro'>
                            <strong>Registro ${index + 1}:</strong><br>
                            ${Object.entries(registro).filter(([key]) => key !== 'diasAposFiscalizacao' && key !== 'dataHoraLancamento' && key !== 'imagemPlaca').map(([key, value]) => `<strong>${key}:</strong> ${value}<br>`).join('')}
                            ${registro.imagemPlaca ? `<img src="${registro.imagemPlaca}" style="max-width: 100px; margin-top: 5px;">` : ''}
                            <button onclick='editarRegistro(${index})'>Editar</button>
                            <button onclick='excluirRegistro(${index})'>Excluir</button>
                        </div>
                    `;
                });
            }
            
            revisaoDiv.style.display = 'block';
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('planilhaResumo').style.display = 'none';
            document.getElementById('autoInfracaoForm').style.display = 'none';
            document.getElementById('infracoesSalvas').style.display = 'none';
        }
        
        function finalizarExpediente() {
            // No longer forcing infraction addition
            if (registros.length === 0 && infracaoRegistros.length === 0) {
                alert("Por favor, adicione pelo menos um registro ou auto de infração antes de finalizar o expediente.");
                return;
            }
            exibirResumoFinal();
        }

        function exibirResumoFinal() {
            const planilhaResumo = document.getElementById('planilhaResumo');
            const tipoLocal = document.getElementById('tipo_local').value;
            const municipioFiscalizacaoPA = document.getElementById('municipio_fiscalizacao_pa').value;
            const dataFiscalizacao = document.getElementById('data').value;
            const servidores = servidoresResponsavel.join(', ');
            const numVeiculos = registros.length;
            const numInfracoes = infracaoRegistros.length;
            
            let dataFormatada = 'Não informada';
            if (dataFiscalizacao) {
                const [ano, mes, dia] = dataFiscalizacao.split('-');
                dataFormatada = `${dia}/${mes}/${ano}`;
            }
            
            const numeroControle = Math.floor(10000 + Math.random() * 90000);
            const letras = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let reportCount = parseInt(localStorage.getItem('reportCount') || '0');
            let seriesIndex = parseInt(localStorage.getItem('seriesIndex') || '0');
            
            reportCount++;
            if (reportCount % 10000 === 0) {
                seriesIndex++;
            }
            
            const letraSerie = letras.charAt(seriesIndex % letras.length);
            
            localStorage.setItem('reportCount', reportCount);
            localStorage.setItem('seriesIndex', seriesIndex);
            
            planilhaResumo.innerHTML = `
                <h2>Resumo da Fiscalização</h2>
                <p><strong>Nº de Controle:</strong> ${numeroControle} / <strong>Série:</strong> ${letraSerie}</p>
                <p>Esta ação foi realizada em: <strong>${municipioFiscalizacaoPA}</strong>, na data: <strong>${dataFormatada}</strong>, pelo servidor(es): <strong>${servidores}</strong>.</p>
                <p>Tipo de Local: <strong>${tipoLocal}</strong></p>
                <p>Foram abordados <strong>${numVeiculos}</strong> veículo(s)/embarcação(ões)${numInfracoes > 0 ? ` e lavrados <strong>${numInfracoes}</strong> auto(s) de infração.` : '.'}</p>
            `;
            
            if (registros.length > 0) {
                planilhaResumo.innerHTML += '<h3>Registros de Trânsito</h3>';
                const tabela = document.createElement('table');
                const cabecalho = tabela.createTHead();
                const corpo = tabela.createTBody();
                
                const columnMapping = {
                    'placa': 'Placa', 'tipo_documento': 'Tipo de Documento', 'numero_documento': 'Número do Documento', 'serie_documento': 'Série do Documento',
                    'finalidade': 'Finalidade', 'especie': 'Espécie', 'quantidade': 'Quantidade', 'unidade_medida': 'Unidade de Medida',
                    'estado_origem': 'Estado de Origem', 'municipio_origem': 'Município de Origem', 'estado_destino': 'Estado de Destino',
                    'municipio_destino': 'Município de Destino', 'dataHoraLancamento': 'Data do Lançamento', 'data': 'Data da Fiscalização'
                };

                const keysToShow = ['placa', 'tipo_documento', 'numero_documento', 'serie_documento', 'finalidade', 'especie', 'quantidade', 'unidade_medida', 'estado_origem', 'municipio_origem', 'estado_destino', 'municipio_destino', 'data', 'dataHoraLancamento'];
                
                const linhaCabecalho = cabecalho.insertRow();
                keysToShow.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = columnMapping[key] || key;
                    linhaCabecalho.appendChild(th);
                });
                
                registros.forEach(registro => {
                    const linha = corpo.insertRow();
                    keysToShow.forEach(key => {
                        const celula = linha.insertCell();
                        celula.textContent = registro[key] || '';
                    });
                });
                
                planilhaResumo.appendChild(tabela);
            } else {
                planilhaResumo.innerHTML += '<p>Nenhum registro de trânsito foi adicionado.</p>';
            }
            
            if (infracaoRegistros.length > 0) {
                planilhaResumo.innerHTML += '<h3>Autos de Infração</h3>';
                const tabelaInfracao = document.createElement('table');
                const cabecalhoInfracao = tabelaInfracao.createTHead();
                const corpoInfracao = tabelaInfracao.createTBody();

                const infracaoKeys = ['numero_auto', 'serie_auto', 'defesa_sanitaria', 'observacao_auto', 'foto_auto'];
                const infracaoMapping = {
                    'numero_auto': 'Número', 'serie_auto': 'Série', 'defesa_sanitaria': 'Defesa Sanitária', 'observacao_auto': 'Observação', 'foto_auto': 'Foto'
                };
                
                const linhaCabecalhoInfracao = cabecalhoInfracao.insertRow();
                infracaoKeys.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = infracaoMapping[key] || key;
                    linhaCabecalhoInfracao.appendChild(th);
                });

                infracaoRegistros.forEach(infracao => {
                    const linha = corpoInfracao.insertRow();
                    infracaoKeys.forEach(key => {
                        const celula = linha.insertCell();
                        if (key === 'foto_auto' && infracao[key]) {
                            const img = document.createElement('img');
                            img.src = infracao[key];
                            img.style.maxWidth = '50px';
                            celula.appendChild(img);
                        } else {
                            celula.textContent = infracao[key] || '';
                        }
                    });
                });

                planilhaResumo.appendChild(tabelaInfracao);
            } else {
                 planilhaResumo.innerHTML += '<p>Nenhum auto de infração foi adicionado.</p>';
            }

            planilhaResumo.innerHTML += `
                <button type="button" onclick="window.print()">Imprimir</button>
                <button type="button" onclick="voltarParaRevisao()">Voltar e Revisar</button>
                <button type="button" onclick="enviarParaBancoDeDados()">Enviar para o Banco de Dados</button>
            `;

            planilhaResumo.style.display = 'block';
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('infracoesSalvas').style.display = 'none';
            document.getElementById('autoInfracaoForm').style.display = 'none';
        }

        function voltarParaRevisao() {
            document.getElementById('planilhaResumo').style.display = 'none';
            revisarDados(); // Show the review section
        }

        function enviarParaBancoDeDados() {
            alert('Funcionalidade "Enviar para o Banco de Dados" não implementada no frontend. Seria necessário um sistema de backend para processar e armazenar esses dados.');
            // Aqui você enviaria 'registros', 'infracaoRegistros', e os dados do formulário inicial
            // Exemplo de como você poderia coletar os dados para enviar (apenas para referência):
            const dadosCompletos = {
                fiscalizacaoInicial: {
                    atividade_realizada: document.getElementById('atividade_realizada').value,
                    data: document.getElementById('data').value,
                    tipo_local: document.getElementById('tipo_local').value,
                    municipio_fiscalizacao_pa: document.getElementById('municipio_fiscalizacao_pa').value,
                    servidoresResponsavel: servidoresResponsavel
                },
                registrosDeTransito: registros,
                autosDeInfracao: infracaoRegistros
            };
            console.log("Dados prontos para envio:", dadosCompletos);
            // Em um ambiente real, você faria uma requisição fetch/XMLHttpRequest para o seu backend aqui.
        }

        function mostrarFormularioInfracao() {
            document.getElementById('autoInfracaoForm').style.display = 'block';
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'none';
            document.getElementById('planilhaResumo').style.display = 'none';
            document.getElementById('infracoesSalvas').style.display = 'none'; // Hide saved infractions if navigating from other place
             // Reset camera for new infraction
            if (videoStreamInfracao) {
                videoStreamInfracao.getTracks().forEach(track => track.stop());
                videoStreamInfracao = null;
            }
            document.getElementById('video-stream-infracao').style.display = 'none';
            document.getElementById('captured-image-infracao').style.display = 'none';
        }

        function cancelarAutoInfracao() {
            document.getElementById('autoInfracaoForm').style.display = 'none';
            document.getElementById('autoInfracaoForm').reset();
            if (videoStreamInfracao) {
                videoStreamInfracao.getTracks().forEach(track => track.stop());
                videoStreamInfracao = null;
                document.getElementById('video-stream-infracao').style.display = 'none';
            }
            document.getElementById('captured-image-infracao').style.display = 'none';
            // After cancelling, usually go back to the records section
            document.getElementById('novosRegistros').style.display = 'block';
            mostrarInfracoesSalvas(); // Show list of saved infractions, if any
        }

        function salvarAutoInfracao() {
            const form = document.getElementById('autoInfracaoForm');
            const novoAuto = {};
            novoAuto.numero_auto = document.getElementById('numero_auto').value;
            novoAuto.serie_auto = document.getElementById('serie_auto').value;
            novoAuto.defesa_sanitaria = document.getElementById('defesa_sanitaria').value;
            novoAuto.observacao_auto = document.getElementById('observacao_auto').value;
            novoAuto.foto_auto = document.getElementById('captured-image-infracao').src;
            
            // Simple validation for auto fields
            if (!novoAuto.numero_auto || !novoAuto.serie_auto || !novoAuto.defesa_sanitaria) {
                alert('Por favor, preencha os campos obrigatórios do Auto de Infração (Número, Série, Tipo de Defesa Sanitária).');
                return;
            }

            infracaoRegistros.push(novoAuto);
            
            alert('Auto de infração salvo com sucesso!');
            document.getElementById('autoInfracaoForm').reset();
            document.getElementById('captured-image-infracao').style.display = 'none';
            if (videoStreamInfracao) {
                videoStreamInfracao.getTracks().forEach(track => track.stop());
                videoStreamInfracao = null;
                document.getElementById('video-stream-infracao').style.display = 'none';
            }
            mostrarInfracoesSalvas();
        }

        function mostrarInfracoesSalvas() {
            const infracoesDiv = document.getElementById('infracoesSalvas');
            infracoesDiv.innerHTML = '<h2>Autos de Infração Registrados:</h2>';
            if (infracaoRegistros.length === 0) {
                infracoesDiv.innerHTML += '<p>Nenhum auto de infração registrado.</p>';
            } else {
                infracaoRegistros.forEach((auto, index) => {
                    infracoesDiv.innerHTML += `
                        <div class='registro'>
                            <strong>Auto ${index + 1}:</strong><br>
                            <strong>Número:</strong> ${auto.numero_auto}<br>
                            <strong>Série:</strong> ${auto.serie_auto}<br>
                            <strong>Tipo:</strong> ${auto.defesa_sanitaria}<br>
                            <strong>Observação:</strong> ${auto.observacao_auto}<br>
                            ${auto.foto_auto && auto.foto_auto !== '' ? `<img src="${auto.foto_auto}" style="max-width: 100px; margin-top: 5px;">` : ''}
                            <button onclick='excluirInfracao(${index})'>Apagar Registro</button>
                        </div>
                    `;
                });
            }
            // Add buttons for flow control
            infracoesDiv.innerHTML += `
                <button type="button" onclick="mostrarFormularioInfracao()">Adicionar Outro Auto de Infração</button>
                <button type="button" onclick="exibirResumoFinal()">Finalizar Expediente</button>
            `;

            infracoesDiv.style.display = 'block';
            document.getElementById('autoInfracaoForm').style.display = 'none';
            document.getElementById('novoRegistroForm').style.display = 'none';
            document.getElementById('revisaoRegistros').style.display = 'none';
            document.getElementById('novosRegistros').style.display = 'block'; // Make sure the main records section is visible
        }

        function excluirInfracao(index) {
            if (confirm("Tem certeza que deseja apagar este auto de infração?")) {
                infracaoRegistros.splice(index, 1);
                mostrarInfracoesSalvas(); // Refresh the saved infractions list
            }
        }


        // Funções para a câmera do registro principal
        async function toggleCamera() {
            const video = document.getElementById('video-stream');
            const btn = document.getElementById('toggle-camera-btn');
            const capturedImage = document.getElementById('captured-image');

            if (videoStream) {
                const canvas = document.getElementById('photo-canvas');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL('image/jpeg');
                capturedImage.src = imageData;
                capturedImage.style.display = 'block';

                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                video.style.display = 'none';
                btn.textContent = 'Tirar Outra Foto';
            } else {
                capturedImage.style.display = 'none';
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); // Prefer rear camera
                    video.srcObject = stream;
                    video.style.display = 'block';
                    btn.textContent = 'Capturar Imagem';
                    videoStream = stream;
                } catch (err) {
                    alert('Não foi possível acessar a câmera.');
                }
            }
        }
        
        // Funções para a câmera do auto de infração
        async function toggleCameraInfracao() {
            const video = document.getElementById('video-stream-infracao');
            const capturedImage = document.getElementById('captured-image-infracao');
            
            if (videoStreamInfracao) {
                const canvas = document.getElementById('photo-canvas-infracao');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvas.toDataURL('image/jpeg');
                capturedImage.src = imageData;
                capturedImage.style.display = 'block';
                
                videoStreamInfracao.getTracks().forEach(track => track.stop());
                videoStreamInfracao = null;
                video.style.display = 'none';
            } else {
                capturedImage.style.display = 'none';
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } }); // Prefer rear camera
                    video.srcObject = stream;
                    video.style.display = 'block';
                    videoStreamInfracao = stream;
                } catch (err) {
                    alert('Não foi possível acessar a câmera para o auto de infração.');
                }
            }
        }
        
        // New functions for adding and displaying servers
        function addServidor() {
            const nomeServidorInput = document.getElementById('nome_servidor');
            const nome = nomeServidorInput.value.trim();
            if (nome && !servidoresResponsavel.includes(nome)) {
                servidoresResponsavel.push(nome);
                nomeServidorInput.value = ''; // Clear input
                displayServidores();
                document.getElementById('servidores_obrigatorio_msg').style.display = 'none';
            } else if (servidoresResponsavel.includes(nome)) {
                alert('Este servidor já foi adicionado.');
            }
        }

        function displayServidores() {
            const listaServidoresDiv = document.getElementById('lista_servidores');
            listaServidoresDiv.innerHTML = '';
            if (servidoresResponsavel.length > 0) {
                const ul = document.createElement('ul');
                servidoresResponsavel.forEach((servidor, index) => {
                    const li = document.createElement('li');
                    li.textContent = servidor;
                    const removeBtn = document.createElement('button');
                    removeBtn.textContent = 'Remover';
                    removeBtn.onclick = () => removeServidor(index);
                    li.appendChild(removeBtn);
                    ul.appendChild(li);
                });
                listaServidoresDiv.appendChild(ul);
            }
        }

        function removeServidor(index) {
            servidoresResponsavel.splice(index, 1);
            displayServidores();
            if (servidoresResponsavel.length === 0) {
                document.getElementById('servidores_obrigatorio_msg').style.display = 'block';
            }
        }
    </script>
</body>
</html>